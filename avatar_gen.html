<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Avatar Generator - Gameverse 2025</title>
  <style>
    body { background:#0b0520; color:#fff; font-family: sans-serif; margin:0; padding:0; }
    .wrap { display:flex; flex-wrap:wrap; gap:20px; padding:20px; }
    .card { background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.1); border-radius:10px; padding:16px; }
    canvas { width: 360px; height: 450px; background:#222; display:block; }
    input, button { margin-top:6px; display:block; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>Tạo thiệp mời Gameverse 2025</h2>
    <label>Ảnh avatar <input id="fileInput" type="file" accept="image/*"></label>
    <label>Họ tên <input id="fullname" type="text" placeholder="Tên của bạn"></label>
    <label>Chức vụ <input id="title" type="text" placeholder="Chức vụ"></label>
    <label>Màu chữ <input id="textColor" type="color" value="#ffffff"></label>
    <label>Cỡ chữ tên <input id="nameSize" type="range" min="28" max="72" value="46"></label>
    <button id="btnRender">Render</button>
    <a id="btnDownload" download="gameverse_avatar.png">Tải ảnh PNG</a>
    <button id="btnClear">Xóa avatar</button>
  </div>
  <div class="card">
    <canvas id="cvs" width="1080" height="1350"></canvas>
  </div>
</div>
<script>
const FRAME_URL = "https://gameverse.vtcmobile.vn/thumoi/Content/images/bg1.png";
const canvas = document.getElementById('cvs');
const ctx = canvas.getContext('2d');
const fileInput = document.getElementById('fileInput');
const fullname = document.getElementById('fullname');
const title = document.getElementById('title');
const textColor = document.getElementById('textColor');
const nameSize = document.getElementById('nameSize');
const btnRender = document.getElementById('btnRender');
const btnDownload = document.getElementById('btnDownload');
const btnClear = document.getElementById('btnClear');

const state = { avatarImg: null };

function loadImage(urlOrBlob) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = urlOrBlob;
  });
}

function drawRoundedImage(img, x, y, size, radius) {
  ctx.save();
  const r = radius;
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.arcTo(x + size, y, x + size, y + size, r);
  ctx.arcTo(x + size, y + size, x, y + size, r);
  ctx.arcTo(x, y + size, x, y, r);
  ctx.arcTo(x, y, x + size, y, r);
  ctx.closePath();
  ctx.clip();
  ctx.drawImage(img, x, y, size, size);
  ctx.restore();
}

fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);
  state.avatarImg = await loadImage(url);
  await render();
});

btnClear.addEventListener('click', () => {
  state.avatarImg = null;
  fileInput.value = "";
  render();
});

[fullname, title, textColor, nameSize].forEach(el => el.addEventListener('input', () => render()));
btnRender.addEventListener('click', () => render());

async function render() {
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0, '#1d0b50');
  g.addColorStop(1, '#0b0530');
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, W, H);

  const avatarRect = { x: 270, y: 430, size: 540, radius: 18 };
  if (state.avatarImg) {
    drawRoundedImage(state.avatarImg, avatarRect.x, avatarRect.y, avatarRect.size, avatarRect.radius);
  }

  ctx.textAlign = 'center';
  ctx.fillStyle = textColor.value || '#fff';
  ctx.shadowColor='rgba(0,0,0,.55)';
  ctx.shadowBlur=10;
  ctx.shadowOffsetY=3;
  ctx.font = `700 ${parseInt(nameSize.value)||46}px sans-serif`;
  ctx.fillText(fullname.value || 'Tên của bạn', W/2, 1040);
  ctx.shadowBlur = 0; ctx.shadowOffsetY = 0;
  ctx.font = `700 36px sans-serif`;
  ctx.fillText(title.value || 'Chức vụ', W/2, 1090);

  try {
    const frameImg = await loadImage(FRAME_URL);
    ctx.drawImage(frameImg, 0, 0, W, H);
  } catch (err) {
    console.error('Không tải được frame:', err);
  }

  try {
    btnDownload.href = canvas.toDataURL('image/png');
  } catch (e) {
    btnDownload.removeAttribute('href');
  }
}

render();
</script>
</body>
</html>
